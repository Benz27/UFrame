<?php
session_start();

include("../php/conn.php");
include("../php/read.php");
include("../php/refund.php");
$user_data=check_login($link);


$t_id=$_GET['t'];


?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refund</title>
    <link href="refund.css" rel="stylesheet" />
    <link href="../css/bootstrap.min.css" rel="stylesheet" />
    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"></script>
    
</head>
<body>
    <div class=" container-fluid my-5 ">
        <div class="row justify-content-center ">
            <div class="col-xl-10">
                <div class="card shadow-lg ">
                    <div class="row p-2 mt-3 justify-content-between mx-sm-2">
                        <!-- <div class="col">
                            <p class="text-muted space mb-0 shop">Shop No.78618K</p>
                            <p class="text-muted space mb-0 shop">Store Locator</p>
                        </div> -->
                        <!-- <div class="col">
                            <div class="row justify-content-start ">
                                <div class="col"> <img class="irc_mi img-fluid cursor-pointer " src="https://i.imgur.com/jFQo2lD.png" width="70" height="70"> </div>
                            </div>
                        </div> -->
                        <!-- <div class="col-auto"> <img class="irc_mi img-fluid bell" src="https://i.imgur.com/uSHMClk.jpg" width="30" height="30"> </div> -->
                    </div>
                    <!-- <div class="row mx-auto justify-content-center text-center">
                        <div class="col-12 mt-3 ">
                            <nav aria-label="breadcrumb" class="second ">
                                <ol class="breadcrumb indigo lighten-6 first ">
                                    <li class="breadcrumb-item font-weight-bold"><a class="black-text text-uppercase " href="../"><span class="mr-md-3 mr-1">BACK TO SHOP</span></a><i class="fa fa-angle-double-right " aria-hidden="true"></i></li>
                                    <li class="breadcrumb-item font-weight-bold"><a class="black-text text-uppercase" href="../cart/"><span class="mr-md-3 mr-1">SHOPPING BAG</span></a><i class="fa fa-angle-double-right text-uppercase " aria-hidden="true"></i></li>
                                    <li class="breadcrumb-item font-weight-bold"><a class="black-text text-uppercase active-2" href="../checkout/"><span class="mr-md-3 mr-1">CHECKOUT</span></a></li>
                                </ol>
                            </nav>
                        </div>
                    </div> -->
                    <div class="row justify-content-around">
                        <div class="col-md-12">
                            <div class="card border-0">
                                <div class="card-header pb-0">
                                    <h2 class="card-title space ">Refund</h2>
                                    <!-- <p class="card-text text-muted mt-4 space">SHIPPING DETAILS</p> -->
                                    <!-- <hr class="my-0"> -->
                                </div>

                                <div class="card-body">
                                    <form action="" method="post" id="form">
                                        <?php
                                        $sql = "SELECT * FROM transac where t_id=$t_id";  
                                  
                      
                                            if($result = mysqli_query($link, $sql)){
                                              if(mysqli_num_rows($result) > 0){ 
                                                $row=mysqli_fetch_assoc($result); 
                                   echo' <div class="row justify-content-between">
                                        <div class="col-auto mt-0">
                                            <p><b>'.$row['street'].', '.$row['bar'].', '.$row['city'].', '.$row['prov'].'</b></p>
                                        </div>
                                        <div class="col-12">
                                            <p><b>'.$row['fname'].'</b> </p>
                                        </div>
                                        <div class="col-12">
                                            <p><b>'.$row['email'].'</b> </p>
                                        </div>
                                        <div class="col-12">
                                            <p><b>'.$row['phone'].'</b> </p>
                                        </div>
                                        </div>';
                                }
                            }
                                            ?>                            <!-- <div class="row mt-4">
                                        <div class="col">
                                            <p class="text-muted mb-2">CONTACT DETAILS</p>
                                            <hr class="mt-0">
                                        </div>
                                    </div> -->
                                    
                                    <!-- <div class="form-group"> <label for="NAME" class="small text-muted mb-1"><span style="color: red;">*</span>NAME</label> <input type="text" class="form-control form-control-sm" name="name" id="name" aria-describedby="helpId" placeholder="Your name"> </div>
                                    <div class="form-group"> <label for="NAME" class="small text-muted mb-1"><span style="color: red;">*</span>PHONE NUMBER</label> <input type="text" class="form-control form-control-sm" name="num" id="num" aria-describedby="helpId" placeholder="Your phone number"> </div>
                                    <div class="form-group"> <label for="NAME" class="small text-muted mb-1"><span style="color: red;">*</span>EMAIL ADDRESS</label> <input type="text" class="form-control form-control-sm" name="email" id="email" aria-describedby="helpId" placeholder="Your email address"> </div>

                                    <hr class="my-0 mt-3">
                                    <div class="form-group mt-2"> <input type="radio" name="rad" id="rad1" onclick="ship(1)" checked> <span class="small mb-1">Pickup (Can be picked up within 2 weeks)</span> <input type="radio" name="rad" id="rad2" onclick="ship(0)" class="ms-5"><span class="small mb-1 ms-1">Delivery (₱400-₱500 Shipping cost)</span></div> -->
                                    <!-- <input type="text" name="shpp" value="0" id="shpp" hidden> -->
                                    
                                  
                                    <!-- <div class="row no-gutters">
                                        <div class="col-sm-6 pr-sm-2">
                                            <div class="form-group"> <label for="NAME" class="small text-muted mb-1">VALID THROUGH</label> <input type="text" class="form-control form-control-sm" name="NAME" id="NAME" aria-describedby="helpId" placeholder="06/21"> </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="form-group"> <label for="NAME" class="small text-muted mb-1">CVC CODE</label> <input type="text" class="form-control form-control-sm" name="NAME" id="NAME" aria-describedby="helpId" placeholder="183"> </div>
                                        </div>
                                    </div> -->

                                </form>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                      <thead>
                                        <tr>
                                          <th scope="col" class="border-0 bg-light">
                                            <div class="p-2 px-3 text-uppercase">Product</div>
                                          </th>
                                          <th scope="col" class="border-0 bg-light">
                                            <div class="py-2 text-uppercase">Unit Price</div>
                                          </th>
                                          <th scope="col" class="border-0 bg-light">
                                            <div class="py-2 text-uppercase">Refund Amount</div>
                                          </th>
                                          <th scope="col" class="border-0 bg-light">
                                            <div class="py-2 text-uppercase">Refund Quantity</div>
                                          </th>
                                          <th scope="col" class="border-0 bg-light">
                                            <div class="py-2 text-uppercase">Ordered Quantity</div>
                                          </th>
                                        </tr>
                                      </thead>

                                <tbody>
                                <?php
                                $sql = "SELECT * FROM transac where t_id=$t_id";  
                          
              
                                    if($result = mysqli_query($link, $sql)){
                                      if(mysqli_num_rows($result) > 0){ 
                                        $row=mysqli_fetch_assoc($result); 
                                        $itms=explode(" ",$row['i_ids']);
                                        $totprice=$row['totprice'];
                                        $pqnt=explode(" ",$row['qnt']);
                                        $price=explode(" ",$row['price']);
                                      }
                                    }



                                for($z=0;$z<count($itms);$z++){
                                    
                                    $sql = "SELECT * FROM items where item_id=$itms[$z]";  
                          
              
                                    if($result = mysqli_query($link, $sql)){
                                      if(mysqli_num_rows($result) > 0){ 

                                        $row=mysqli_fetch_assoc($result); 
                                        
                                        $id=$row['item_id'];
            
                                        

                                        $med=explode("|",$row['filename']);
                                        $det=explode("|*|",$row['details']); 


                                        echo '
                                       

                           
                                                
                                  
                              <th scope="row">
                                <div class="p-2">
                                  <input type="checkbox" class="align-middle" id="'.$id.'" onclick="chck('.$id.')">
                                  <img src="'. '..'.$row['mdir'].$med[0] .'" alt="" width="70" class="img-fluid rounded shadow-sm">
                                  <div class="ml-3 d-inline-block align-middle">
                                    <h5 class="mb-0"><a href="../item/?item='.$id.'" class="text-dark d-inline-block align-middle">'.$row['name'].'</a></h5><span class="text-muted font-weight-normal font-italic d-block">Category: '.$det[0].'</span>
                                  </div>
                                </div>
                              </th>
                              <td class="border-0 align-middle"><strong>₱<span>'.$price[$z].'</span></strong></td>
                              <td class="border-0 align-middle"><strong>₱<span id="'.$id.'pr"  name="'.$row['price'].'">'.$price[$z].'</span></strong></td>
                              <td class="align-middle">
                                <button class="btn btn-dark mt-auto" id="'.$id.'min" onclick="quan(-1,'.$id.','.$pqnt[$z].',0)" value="0">-</button>
                                <input id="'.$id.'inp" style="width: 8%;margin: 1%;text-align: center;" type="text" value="1" onkeypress="return numonly(event);" onkeyup="qnl(this.value,'.$id.','.$pqnt[$z].');" onchange="addto('.$id.',3,'.$pqnt[$z].',this.value);"></input>
                                <button class="btn btn-dark mt-auto" id="'.$id.'max" onclick="quan(1,'.$id.','.$pqnt[$z].',0)" value="0">+</button>
                             
                              </td>
                              <td class="align-middle">   <input id="'.$id.'stk"style="width: 15%;margin-left: 2%;text-align: center;margin-top:1%;" type="text" value="'.$pqnt[$z].'" disabled /></td>
                            </tr>
                         

';

                                      }
                                    }
                                }
                            

                                    echo '</tbody>
                                </table>
                                    </div>';
                                ?>
                                    <!-- <div class="row mb-5 mt-4 ">
                                        <div class="col-md-7 col-lg-6 mx-auto"><button type="button" class="btn btn-block btn-outline-primary btn-lg">ADD GIFT CODE</button></div>
                                    </div> -->
                                    <!-- <div class="row justify-content-between">
                                        <div class="col-5">
                                            <p class="mb-1"><b>Shipping</b></p>
                                        </div>
                                        <div class="flex-sm-col col-auto">
                                            <p class="mb-1"><b>₱<span id="shp">0</span></b></p>
                                        </div>
                                    </div>
                                    <div class="row justify-content-between">
                                        <div class="col-4">
                                            <p><b>Total</b></p>
                                        </div>
                                        <div class="flex-sm-col col-auto">
                                            <p class="mb-1"><b>₱<span id="totp">'.$totprice.'</span></b></p>
                                        </div>
                                    </div> -->
                                </div>




                                <div class="col-lg-12">
                                    <div class="p-4">
                                      <ul class="list-unstyled mb-4">
                                       
                                        <li class="d-flex justify-content-between py-3 border-bottom"><strong class="text-muted">Total Refund Amount: </strong>
                                          <h5 class="font-weight-bold">₱<span id="tprice">0</span></h5>
                                        </li>
                                      </ul>
                                    </div>
                                  </div>


                                <div class="col-lg-12">
                                   

                                    <div class="bg-light rounded-pill px-4 mt-3 text-uppercase small">Reason for refund</div>
                                    <div class="p-4">
                                      <!-- <p class="font-italic mb-4">If you have some information for the seller you can leave them in the box below</p> -->
                                      <textarea name="note" cols="30" rows="9" class="form-control" placeholder="Please state your reason here..."></textarea>
                                    </div>
                                  </div>

                                  <div class="row mb-md-5">
                                    <div class="col"> <button type="submit" name="" id="" class="col-12 btn btn-lg btn-block btn-warning mt-3">REFUND</button> </div>
                                </div>

                                
                                
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
  const arrurl=[];
var arcount=0;
const price =[];
function qnl(x,y,z){
    if(!isNaN(x) && x!=""){
        if(x>Number(z)){
        document.getElementById(y+"inp").value=z;
        }
    }
}


function numonly(e) {
    e = (e) ? e : window.event;
    var chr = (e.which) ? e.which : e.keyCode;
    if (chr > 31 && (chr < 48 || chr > 57)) {
     return false;
    }else{
      return true;
    }
}

function tprice(x,y){
  var p=0;
  if (y==1) {
        price.push(x);
  } else if (y==0){
        const index = price.indexOf(x);
        if(index>-1){
          price.splice(index, 1);
        }
  }
  for(z=0;z<price.length;z++){
      p+=(Number(document.getElementById(price[z]+"pr").getAttribute("name"))*Number(document.getElementById(price[z]+"inp").value));
  }
  document.getElementById("tprice").innerHTML=p;
}



function rem(x,y){
  const arrrem=[x];
  if(y>0){
    arrrem=arrurl;
  }
    for(let g=0,j=0;g < arrrem.length;g++){
                    addto(arrrem[j],2,0,0);
                    if(document.getElementById(arrrem[j]+"tr")){
                      document.getElementById(arrrem[j]+"tr").remove();
                      const index = arrrem.indexOf(arrrem[j]);
                      arrrem.splice(index, 1);
                    }             
    }
}

function chck(a){
  var checkbox = document.getElementById(a);
  if (checkbox.checked) {
        arrurl.push(a);
        tprice(a,1);
  } else {
        const index = arrurl.indexOf(a);
        arrurl.splice(index, 1);
        tprice(a,0);
  }
  arcount = arrurl.length;
  if (arcount > 0){
    document.getElementById("chck").disabled=false;
  }else{
    document.getElementById("chck").disabled=true;
  }
  uval = arrurl.filter(Boolean).join("+")
  document.getElementById("chcka").href = "../checkout/?items="+uval;
}

function quan(x,z,q,o){

var y=Number(document.getElementById(z+"inp").value);


  if(y>1||x==1){
    if(y<q||x==-1){
    y+=Number(x);
    if(y>q){

     }else{
        addto(z,o,q,x);
        

     }
  }
}



}

        // var rad=0;
        // function ship(x){
        //     if(x==1){
        //         rad=1;
        //         document.getElementById("shpp").value=rad;
        //     }else if(x==0){
        //         rad=0;
        //         document.getElementById("shpp").value=rad;
        //     }
        // }

        var rad=1;
        var u = window.location.href;
                    var ur = new URL(u);
        var p = ur.searchParams.get("items");

        p=p.replace(/ /g, "+");
        document.getElementById("form").setAttribute("action","./?items="+p+"&shp="+rad);
        
        function ship(x){
            // shp=Number(document.getElementById("shp").innerHTML);
            // totp=Number(document.getElementById("totp").innerHTML);
            // f=0;
            if(x==1){
                rad=1;
                // f=400;
            }else if(x==0){
                rad=0;
                // f=-400;
            }
            var u = window.location.href;
                    var ur = new URL(u);
        var p = ur.searchParams.get("items");

        p=p.replace(/ /g, "+");
        document.getElementById("form").setAttribute("action","./?items="+p+"&shp="+rad);
            // document.getElementById("shp").innerHTML=shp+f;
            // document.getElementById("totp").innerHTML=totp+f;
        }

    </script>
</body>
</html>