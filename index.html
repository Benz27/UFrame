<?php
session_start();
//unset($_SESSION['user_id']);
include("php/conn.php");
include("php/read.php");
include("php/about.php");
if(isset($_SESSION['user_id'])){
    include("php/cart.php");
}

$shop="";
$st="";
$stn="";
if(isset($_GET['s'])){
    $st="and category='$_GET[s]'";
    $stn="and category<>'$_GET[s]'";
}


function get_price_range($link,$item_id){

    $sql = "SELECT DISTINCT v_id FROM inventory where item_id=$item_id";
    $result = mysqli_query($link, $sql);
    if ($result && mysqli_num_rows($result) > 0) {
        $row = mysqli_fetch_assoc($result);

        $sql = "SELECT min(selling_price) as 'min', max(selling_price) as 'max' FROM inventory where v_id=$row[v_id]";
        $result = mysqli_query($link, $sql);
        if ($result && mysqli_num_rows($result) > 0) {
            $row = mysqli_fetch_assoc($result);
            if($row['min']==$row['max']){
                return '₱'.$row['min'];
            }
            return '₱'.$row['min'].' - ₱'.$row['max'];
        }
    }

}


function get_v_sum($link,$item_id){

    $sql = "SELECT DISTINCT v_id FROM inventory where item_id=$item_id";
    $result = mysqli_query($link, $sql);
    if ($result && mysqli_num_rows($result) > 0) {
        $row = mysqli_fetch_assoc($result);

        $sql = "SELECT sum(selling_price) as 'sum' FROM inventory where v_id=$row[v_id]";
        $result = mysqli_query($link, $sql);
        if ($result && mysqli_num_rows($result) > 0) {
            $row = mysqli_fetch_assoc($result);
            if($row['sum']==NULL){
                return 0;
            }
            return $row['sum'];
        }
    }

}


$tr='';

//print_r($s_cart);
//print_r($s_qnt);
$user_data=check_login($link);
$med;
//$sql = "SELECT * FROM inventory $st";
$sql= "SELECT * FROM `inventory` WHERE `v_id` = 0 
UNION
SELECT * FROM `inventory` WHERE `v_id` IN (SELECT DISTINCT `v_id` from `inventory` WHERE `v_id` > 0) GROUP BY `v_id`;
";
if($st!=""){
    $sql= "SELECT * FROM `inventory` WHERE `v_id` = 0 $st
    UNION
    SELECT * FROM `inventory` WHERE `v_id` IN (SELECT DISTINCT `v_id` from `inventory` WHERE `v_id` > 0) $st GROUP BY `v_id`
    UNION
    SELECT * FROM `inventory` WHERE `v_id` = 0 $stn
    UNION
    SELECT * FROM `inventory` WHERE `v_id` IN (SELECT DISTINCT `v_id` from `inventory` WHERE `v_id` > 0) $stn GROUP BY `v_id`;
    ";
}

?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>
        <?php echo $abt_name;?> - Shop
    </title>
    <!-- Favicon-->
    <!-- <link rel="icon" type="image/x-icon" href="assets/favicon.ico" /> -->
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <style>
        .vertical-center {
            min-height: 100%;
            min-height: 100vh;
            align-items: center;
        }
    </style>
</head>

<body>

    <main>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container px-4 px-lg-5">
                <a class="nav-link" href="./"
                    style="font-family: Myriad;font-weight: bolder;color: black;font-size: 30px;">
                    <?php echo $abt_name;?>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation"><span
                        class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                        <!-- <li class="nav-item"><a class="nav-link" href="./login/">Log in</a></li> -->
                        <li class="nav-item"><a class="nav-link" href="./aboutus/">About</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" id="navbarDropdown" style="cursor: pointer;"
                                role="button" data-bs-toggle="dropdown" aria-expanded="false">Shop</a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown" id="category">
                                <li><a class="dropdown-item" href="./">All Products</a></li>
                                <li>
                                    <hr class="dropdown-divider" />
                                </li>

                            </ul>
                        </li>
                        <li class="nav-item">
                            <?php
                            if($s_id){
                                echo '<a class="nav-link" id="shp" role="button" aria-current="page" href="./profile/info/">Profile</a>';
                            }else{
                                echo '<a class="nav-link" id="shp" role="button" aria-current="page" href="./login/">Log-In</a>';
                            }
                            ?>
                        </li>
                    </ul>
                    <?php 
                    if($s_id){
                        echo '<a href="./cart/">';

                    }else{
                        echo '<a href="./login/">';
                    }
                    ?>


                    <button class="btn btn-outline-dark" type="button">
                        <i class="bi-cart-fill me-1"></i>
                        Cart
                        <?php 
                            if($s_id){
                                echo '<span class="badge bg-dark text-white ms-1 rounded-pill" id="crtnum"> '.count($s_cart).'</span>';

                            }
                            ?>
                    </button>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Header -->
        <!-- <header class="bg-dark py-5">
            <div class="container px-4 px-lg-5 my-5">
                <div class="text-center text-white">
                    <h1 class="display-4 fw-bolder">Shop in style</h1>
                    <p class="lead fw-normal text-white-50 mb-0">With this shop hompeage template</p>
                </div>
            </div>
        </header> -->
        <!-- Section-->
        <section class="py-5" style="margin-bottom: 5%;">
            <div class="container px-4 px-lg-5 mt-5">
                <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">


                    <?php 
                    if($result = mysqli_query($link, $sql)){
                        if(mysqli_num_rows($result) > 0){ 
                          while($row = mysqli_fetch_array($result)){  
                            $k;
                            $a=false;
                            
                            if($row['v_id']>0){
                                $iitem_id=$row['item_id'];
                                $stock=get_v_sum($link,$iitem_id);
                            }else{
                                $stock=$row['quantity'];
                            }
                            $inh="Available";
                            $dis="";
                            //foreach (array_keys($s_cart, $row['item_id']) as $key) {
                                //$k=$key;
                                //$a=true;
                            //}
                            //if($a){
                                //if($s_qnt[$k]==$stock){
                                   // $inh="Max quantity on cart";

                                //}
                           // }
                            if($stock==0){

                                $inh="Sold Out";
                            }
                            

                            $med=explode("|",$row['media']);
            echo '<div class="col mb-5">
                        <div class="card h-100">
                        
                            <div class="badge bg-dark text-white position-absolute" style="top: 0.5rem; right: 0.5rem">'.$inh.'</div>';
                        
                            if($row['v_id']>0){
                                echo'<a href="./vitem/?item='.$row['v_id'].'">
                                    <img class="img-fluid" style="width: 300px;height: 300px;" 
                                    src="'. './images/vproducts/'.$row['v_id'].'/'.$med[0] .'" alt="..." />
                                    </a>';

                            }else{
                                echo'<a href="./item/?item='.$row['item_id'].'">
                                    <img class="img-fluid" style="width: 300px;height: 300px;" 
                                    src="'. './images/products/'.$row['item_id'].'/'.$med[0] .'" alt="..." />
                                    </a>';

                            }


                        
                            echo'<div class="card-body p-4">
                                <div class="text-center">
                          
                                    <h5 class="fw-bolder">'.$row['name'].'</h5>

                                    <!-- <span class="text-muted text-decoration-line-through">₱50</span> -->
                                    ';

                               
                                    if($row['v_id']>0){
                                        $iitem_id=$row['item_id'];
                                        echo get_price_range($link,$iitem_id);
                                        
                                    }else{
                                        echo'₱'.$row['selling_price'];
                                    }
                                    
                                echo'</div>
                                <hr>
                                <!-- <div class="d-flex justify-content-end small text-dark mb-2">
                                    4 sold
                                </div> -->
                            </div>
                        
                            <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">';
                                
                                if($row['v_id']>0){
                                    echo'  <div class="text-center"> <a href="./vitem/?item='.$row['v_id'].'">
                                        <button class="btn btn-outline-dark mt-auto" id="'.$row['item_id'].'" >View Options</button></a>
                                        </div>';
                                }else{
                                    echo'  <div class="text-center"> <a href="./item/?item='.$row['item_id'].'">
                                        <button class="btn btn-outline-dark mt-auto" id="'.$row['item_id'].'" >View More</button></a>
                                        </div>';
                                }



                    echo'</div>
                    </div> 
                </div> ';





                          }
                        }else{

                           echo'
                                                                                    
      
                                    <div class="text-center" style="margin-bottom: 25%;margin-top: 10%;">';
                            
                                        if(isset($_GET['s'])){
                                          echo'<h5 class="fw-ligh">No items available for '.$_GET['s'].' category.</h5>';
                                        }else{
                                            echo'<h5 class="fw-ligh">No items available at this moment.</h5>';

                                        }

                                    echo'</div>
                      
                            
                      ';
                        }
                    }
                   
                    
                    
                    
                    ?>



                </div>
            </div>
        </section>
        <!-- Footer-->
        <footer class="py-5 bg-dark">
            <div class="container">
                <p class="m-0 text-center text-white">Copyright &copy;
                    <?php echo $abt_name;?> 2022
                </p>
            </div>
        </footer>

    </main>
    <div id="cmodal" class="modal" tabindex="-1" role="dialog" <?php echo $tr;?>>
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Cart</h5>
                </div>



                <div id="ld">
                    <div class="modal-body">
                        <p>There were items left in your cart. Do you want to save these item to your account's cart?.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="mdyes">Yes</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="mdno">No</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="myModal" class="modal vertical-center">

        <div class="modal-dialog" role="document">
            <div class="modal-content border border-4 border-dark">
                <div class="modal-body align-self-center">
                    <p class="bi-cart-check" style="font-size: 100px;"></p>
                </div>
                <div class="modal-footer align-self-center">Item has been added to your cart.</div>
            </div>
        </div>

    </div>


    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./js/jquery-3.6.0.js"></script>
    <!-- Core theme JS-->
    <!-- <script src="js/scripts.js"></script> -->

    <style type="text/css">
        @import url('https://fonts.googleapis.com/css2?family=Birthstone&family=Poppins:ital,wght@0,400;0,500;0,600;1,600;1,800&display=swap');
    </style>
    <script>

        var modal = document.getElementById("myModal");
        var cmodal = document.getElementById("cmodal");


        get_categories();

        function get_categories() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    const arr = this.responseText.split(",");

                    const element = document.getElementById("category");
                    for (x = 0; x < arr.length; x++) {
                        const li = document.createElement("li");
                        const a = document.createElement("a");
                        const atxt = document.createTextNode(arr[x]);
                        a.setAttribute("class", "dropdown-item");
                        a.appendChild(atxt);
                        a.href = "./?s=" + arr[x];
                        li.appendChild(a);
                        element.appendChild(li);
                    }
                };
            }
            xhttp.open("GET", "./php/call_functions.php?x=get_categories", true);
            xhttp.send();
        };



        document.getElementById("mdyes").onclick = function () {

            document.getElementById("ld").innerHTML = '<div class="text-center"><div class="spinner-border m-5" role="status"></div></div>';
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {

                if (this.readyState == 4 && this.status == 200) {
                    location.reload();
                };
            }
            xhttp.open("GET", "./php/call_functions.php?x=trc", true);
            xhttp.send();
        };

        document.getElementById("mdno").onclick = function () {

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {

                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("crtnum").innerHTML = 0;
                    console.log(this.responseText);
                    cmodal.style.display = "none";
                };
            }
            xhttp.open("GET", "./php/call_functions.php?x=clr", true);
            xhttp.send();
        };

        modal.onclick = function () {
            modal.style.display = "none";

        }

        window.onclick = function (event) {
            modal.style.display = "none";

        }


        function addto(x, z, st) {
            var btn = document.getElementById(x);
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {

                if (this.readyState == 4 && this.status == 200) {
                    var str = this.responseText;
                    const ar = str.split(",");
                    var y = ar[0];
                    // console.log(ar[0]+", "+ar[1]);
                    // console.log(ar[2]);
                    if (y == 1) {
                        modal.style.display = "flex";

                        //   btn.value=1;
                        //   btn.innerHTML="On cart";
                        //   btn.setAttribute("class","btn btn-dark mt-auto");
                    } else if (y == 3) {
                        //   btn.value=0;
                        //   btn.innerHTML="Add to cart";
                        //   btn.setAttribute("class","btn btn-outline-dark mt-auto");
                    } else if (y == 4) {
                        modal.style.display = "flex";
                        //   btn.value=0;
                        btn.innerHTML = "Max quantity on cart";
                        //   btn.setAttribute("class","btn btn-outline-dark mt-auto");
                        btn.disabled = true;

                    }
                    document.getElementById("crtnum").innerHTML = ar[1];;
                }
            };

            xhttp.open("GET", "./php/fncart.php?id=" + x + "&x=" + z + "&st=" + st, true);
            xhttp.send();
        }

    </script>
</body>

</html>